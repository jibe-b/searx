e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600   1) from collections import defaultdict
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600   2) import mock
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600   3) from searx.engines import nyaa
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600   4) from searx.testing import SearxTestCase
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600   5) 
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600   6) 
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600   7) class TestNyaaEngine(SearxTestCase):
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600   8) 
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600   9)     def test_request(self):
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600  10)         query = 'test_query'
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600  11)         dic = defaultdict(dict)
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600  12)         dic['pageno'] = 1
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600  13)         params = nyaa.request(query, dic)
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600  14)         self.assertTrue('url' in params)
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600  15)         self.assertTrue(query in params['url'])
01330f71 (misnyo        2017-08-31 21:32:30 +0200  16)         self.assertTrue('nyaa.si' in params['url'])
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600  17) 
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600  18)     def test_response(self):
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600  19)         resp = mock.Mock(text='<html></html>')
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600  20)         self.assertEqual(nyaa.response(resp), [])
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600  21) 
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600  22)         html = """
01330f71 (misnyo        2017-08-31 21:32:30 +0200  23)         <table class="table table-bordered table-hover table-striped torrent-list">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  24)         <thead>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  25)         <tr>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  26)         <th class="hdr-category text-center" style="width:80px;">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  27)         <div>Category</div>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  28)         </th>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  29)         <th class="hdr-name" style="width:auto;">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  30)         <div>Name</div>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  31)         </th>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  32)         <th class="hdr-comments sorting text-center" title="Comments" style="width:50px;">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  33)         <a href="/?f=0&amp;c=0_0&amp;q=Death+Parade&amp;s=comments&amp;o=desc"></a>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  34)         <i class="fa fa-comments-o"></i>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  35)         </th>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  36)         <th class="hdr-link text-center" style="width:70px;">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  37)         <div>Link</div>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  38)         </th>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  39)         <th class="hdr-size sorting text-center" style="width:100px;">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  40)         <a href="/?f=0&amp;c=0_0&amp;q=Death+Parade&amp;s=size&amp;o=desc"></a>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  41)         <div>Size</div>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  42)         </th>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  43)         <th class="hdr-date sorting_desc text-center" title="In local time" style="width:140px;">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  44)         <a href="/?f=0&amp;c=0_0&amp;q=Death+Parade&amp;s=id&amp;o=asc"></a>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  45)         <div>Date</div>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  46)         </th>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  47)         <th class="hdr-seeders sorting text-center" title="Seeders" style="width:50px;">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  48)         <a href="/?f=0&amp;c=0_0&amp;q=Death+Parade&amp;s=seeders&amp;o=desc"></a>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  49)         <i class="fa fa-arrow-up" aria-hidden="true"></i>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  50)         </th>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  51)         <th class="hdr-leechers sorting text-center" title="Leechers" style="width:50px;">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  52)         <a href="/?f=0&amp;c=0_0&amp;q=Death+Parade&amp;s=leechers&amp;o=desc"></a>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  53)         <i class="fa fa-arrow-down" aria-hidden="true"></i>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  54)         </th>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  55)         <th class="hdr-downloads sorting text-center" title="Completed downloads" style="width:50px;">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  56)         <a href="/?f=0&amp;c=0_0&amp;q=Death+Parade&amp;s=downloads&amp;o=desc"></a>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  57)         <i class="fa fa-check" aria-hidden="true"></i>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  58)         </th>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  59)         </tr>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  60)         </thead>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  61)         <tbody>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  62)         <tr class="default">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  63)         <td style="padding:0 4px;">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  64)         <a href="/?c=1_2" title="Anime - English-translated">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  65)         <img src="/static/img/icons/nyaa/1_2.png" alt="Anime - English-translated">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  66)         </a>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  67)         </td>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  68)         <td colspan="2">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  69)         <a href="/view/1" title="Sample title 1">Sample title 1</a>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  70)         </td>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  71)         <td class="text-center" style="white-space: nowrap;">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  72)         <a href="/download/1.torrent"><i class="fa fa-fw fa-download"></i></a>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  73)         <a href="magnet:?xt=urn:btih:2"><i class="fa fa-fw fa-magnet"></i></a>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  74)         </td>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  75)         <td class="text-center">723.7 MiB</td>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  76)         <td class="text-center" data-timestamp="1503307456" title="1 week 3
01330f71 (misnyo        2017-08-31 21:32:30 +0200  77)         days 9 hours 44 minutes 39 seconds ago">2017-08-21 11:24</td>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  78)         <td class="text-center" style="color: green;">1</td>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  79)         <td class="text-center" style="color: red;">3</td>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  80)         <td class="text-center">12</td>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  81)         </tr>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  82)         <tr class="default">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  83)         <td style="padding:0 4px;">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  84)         <a href="/?c=1_2" title="Anime - English-translated">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  85)         <img src="/static/img/icons/nyaa/1_2.png" alt="Anime - English-translated">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  86)         </a>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  87)         </td>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  88)         <td colspan="2">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  89)         <a href="/view/2" title="Sample title 2">Sample title 2</a>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  90)         </td>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  91)         <td class="text-center" style="white-space: nowrap;">
01330f71 (misnyo        2017-08-31 21:32:30 +0200  92)         <a href="magnet:?xt=urn:btih:2"><i class="fa fa-fw fa-magnet"></i></a>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  93)         </td>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  94)         <td class="text-center">8.2 GiB</td>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  95)         <td class="text-center" data-timestamp="1491608400" title="4 months 3
01330f71 (misnyo        2017-08-31 21:32:30 +0200  96)         weeks 4 days 19 hours 28 minutes 55 seconds ago">2017-04-08 01:40</td>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  97)         <td class="text-center" style="color: green;">10</td>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  98)         <td class="text-center" style="color: red;">1</td>
01330f71 (misnyo        2017-08-31 21:32:30 +0200  99)         <td class="text-center">206</td>
01330f71 (misnyo        2017-08-31 21:32:30 +0200 100)         </tr>
01330f71 (misnyo        2017-08-31 21:32:30 +0200 101)         </tbody>
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600 102)         </table>
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600 103)         """
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600 104) 
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600 105)         resp = mock.Mock(text=html)
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600 106)         results = nyaa.response(resp)
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600 107) 
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600 108)         self.assertEqual(type(results), list)
01330f71 (misnyo        2017-08-31 21:32:30 +0200 109)         self.assertEqual(len(results), 2)
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600 110) 
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600 111)         r = results[0]
01330f71 (misnyo        2017-08-31 21:32:30 +0200 112)         self.assertTrue(r['url'].find('1') >= 0)
01330f71 (misnyo        2017-08-31 21:32:30 +0200 113)         self.assertTrue(r['torrentfile'].find('1.torrent') >= 0)
01330f71 (misnyo        2017-08-31 21:32:30 +0200 114)         self.assertTrue(r['content'].find('Anime - English-translated') >= 0)
01330f71 (misnyo        2017-08-31 21:32:30 +0200 115)         self.assertTrue(r['content'].find('Downloaded 12 times.') >= 0)
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600 116) 
01330f71 (misnyo        2017-08-31 21:32:30 +0200 117)         self.assertEqual(r['title'], 'Sample title 1')
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600 118)         self.assertEqual(r['seed'], 1)
e5677ae6 (Kirill Isakov 2016-03-25 00:24:37 +0600 119)         self.assertEqual(r['leech'], 3)
01330f71 (misnyo        2017-08-31 21:32:30 +0200 120)         self.assertEqual(r['filesize'], 723700000)
01330f71 (misnyo        2017-08-31 21:32:30 +0200 121) 
01330f71 (misnyo        2017-08-31 21:32:30 +0200 122)         r = results[1]
01330f71 (misnyo        2017-08-31 21:32:30 +0200 123)         self.assertTrue(r['url'].find('2') >= 0)
01330f71 (misnyo        2017-08-31 21:32:30 +0200 124)         self.assertTrue(r['magnetlink'].find('magnet:') >= 0)
